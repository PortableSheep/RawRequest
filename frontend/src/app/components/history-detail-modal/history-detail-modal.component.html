@if (item()) {
  <div class="rr-modal-shell">
    <div class="rr-modal history-detail-modal modal-animated" role="dialog" aria-modal="true" aria-labelledby="history-modal-title">
      <div class="rr-modal__header">
        <div class="history-detail-modal__headline">
          <span class="history-detail-modal__method rr-mono" [attr.data-method]="item()!.method">{{ item()!.method }}</span>
          <h5 id="history-modal-title" class="history-detail-modal__url rr-mono" [title]="item()!.url">{{ item()!.url }}</h5>
        </div>
        <button type="button" class="rr-icon-btn rr-modal__close" (click)="onClose.emit()" aria-label="Close modal">
          <svg xmlns="http://www.w3.org/2000/svg" class="rr-icon rr-icon--md" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6L6 18M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="history-detail-modal__meta">
        <div class="history-detail-modal__meta-grid">
          <div class="history-detail-modal__meta-item">
            <div class="history-detail-modal__meta-label">Status</div>
            <div>
              <span
                class="rr-status"
                [class.rr-status--success]="item()!.status >= 200 && item()!.status < 300"
                [class.rr-status--warning]="item()!.status >= 300 && item()!.status < 400"
                [class.rr-status--error]="item()!.status >= 400 || item()!.status === 0"
                [class.rr-status--neutral]="item()!.status < 200 && item()!.status !== 0"
              >
                {{ item()!.status || 'ERR' }} {{ item()!.statusText }}
              </span>
            </div>
          </div>
          <div class="history-detail-modal__meta-item">
            <div class="history-detail-modal__meta-label">Response Time</div>
            <div class="history-detail-modal__meta-value rr-mono">{{ item()!.responseTime }}ms</div>
          </div>
          <div class="history-detail-modal__meta-item">
            <div class="history-detail-modal__meta-label">Size</div>
            <div class="history-detail-modal__meta-value rr-mono">{{ item()!.responseData.body.length }} bytes</div>
          </div>
          <div class="history-detail-modal__meta-item">
            <div class="history-detail-modal__meta-label">Time</div>
            <div class="history-detail-modal__meta-value rr-mono">{{ formatTime(item()!.timestamp) }}</div>
          </div>
        </div>
      </div>

      <div class="history-detail-modal__tabs" role="tablist" aria-label="Response details">
        @if (isLoadTest()) {
          <button
            class="history-detail-modal__tab"
            [class.history-detail-modal__tab--active]="activeTab==='summary'"
            (click)="activeTab='summary'"
            role="tab"
            [attr.aria-selected]="activeTab==='summary'"
            aria-controls="tabpanel-summary"
            id="tab-summary"
          >
            Summary
          </button>
          <button
            class="history-detail-modal__tab"
            [class.history-detail-modal__tab--active]="activeTab==='raw'"
            (click)="activeTab='raw'"
            role="tab"
            [attr.aria-selected]="activeTab==='raw'"
            aria-controls="tabpanel-raw"
            id="tab-raw"
          >
            Raw JSON
          </button>
        } @else {
          <button
            class="history-detail-modal__tab"
            [class.history-detail-modal__tab--active]="activeTab==='body'"
            (click)="activeTab='body'"
            role="tab"
            [attr.aria-selected]="activeTab==='body'"
            aria-controls="tabpanel-body"
            id="tab-body"
          >
            Response Body
          </button>
        }

        <button
          class="history-detail-modal__tab"
          [class.history-detail-modal__tab--active]="activeTab==='headers'"
          (click)="activeTab='headers'"
          role="tab"
          [attr.aria-selected]="activeTab==='headers'"
          aria-controls="tabpanel-headers"
          id="tab-headers"
        >
          Headers
        </button>
      </div>

      <div class="history-detail-modal__content">
        @if (isLoadTest() && activeTab === 'summary') {
          <div id="tabpanel-summary" role="tabpanel" aria-labelledby="tab-summary" class="history-detail-modal__panel">
            @if (getLoadTestMetrics(); as m) {
              @if (m.cancelled || m.aborted) {
                <div class="rr-card history-detail-modal__notice">
                  <div class="history-detail-modal__notice-title">
                    {{ m.cancelled ? 'Cancelled' : 'Aborted early' }}
                  </div>
                  @if (m.abortReason) {
                    <div class="history-detail-modal__notice-sub">{{ m.abortReason }}</div>
                  }
                </div>
              }

              <div class="history-detail-modal__cards">
                <div class="rr-card">
                  <div class="rr-card__kicker">Total Requests</div>
                  <div class="rr-card__value">{{ m.totalRequests }}</div>
                </div>
                <div class="rr-card">
                  <div class="rr-card__kicker">Success Rate</div>
                  <div class="rr-card__value rr-card__value--success">{{ (100 - m.errorRate).toFixed(1) }}%</div>
                </div>
                <div class="rr-card">
                  <div class="rr-card__kicker">Req/sec</div>
                  <div class="rr-card__value">{{ m.requestsPerSecond.toFixed(2) }}</div>
                </div>
                <div class="rr-card">
                  <div class="rr-card__kicker">Duration</div>
                  <div class="rr-card__value">{{ m.duration.toFixed(2) }}s</div>
                </div>
              </div>

              @if (m.adaptive; as a) {
              @if (a.enabled) {
                <div class="rr-card history-detail-modal__section">
                  <div class="history-detail-modal__section-head">
                    <div class="history-detail-modal__section-title">Adaptive backoff</div>
                    @if (a.phase) {
                      <div class="history-detail-modal__section-sub">Phase: {{ a.phase }}</div>
                    }
                  </div>

                  <div class="history-detail-modal__adaptive">
                    <div class="rr-card rr-card--soft history-detail-modal__adaptive-card">
                      <div class="rr-card__kicker">Peak (first unstable)</div>
                      <div class="history-detail-modal__kv">
                        <div class="history-detail-modal__kv-k">Users</div>
                        <div class="history-detail-modal__kv-v rr-mono">{{ a.peakUsers ?? '—' }}</div>
                        <div class="history-detail-modal__kv-k">Window fail rate</div>
                        <div class="history-detail-modal__kv-v rr-mono">{{ a.peakWindowFailureRate != null ? (a.peakWindowFailureRate * 100).toFixed(2) + '%' : '—' }}</div>
                        <div class="history-detail-modal__kv-k">Window RPS</div>
                        <div class="history-detail-modal__kv-v rr-mono">{{ a.peakWindowRps != null ? a.peakWindowRps.toFixed(2) : '—' }}</div>
                        <div class="history-detail-modal__kv-k">Time to first failure</div>
                        <div class="history-detail-modal__kv-v rr-mono">{{ a.timeToFirstFailureMs != null ? (a.timeToFirstFailureMs / 1000).toFixed(2) + 's' : '—' }}</div>
                      </div>
                    </div>

                    <div class="rr-card rr-card--soft history-detail-modal__adaptive-card">
                      <div class="rr-card__kicker">Stabilized</div>
                      <div class="history-detail-modal__kv">
                        <div class="history-detail-modal__kv-k">Stable</div>
                        <div class="history-detail-modal__kv-v rr-mono">{{ a.stabilized ? 'yes' : 'no' }}</div>
                        <div class="history-detail-modal__kv-k">Users</div>
                        <div class="history-detail-modal__kv-v rr-mono">{{ a.stableUsers ?? '—' }}</div>
                        <div class="history-detail-modal__kv-k">Window fail rate</div>
                        <div class="history-detail-modal__kv-v rr-mono">{{ a.stableWindowFailureRate != null ? (a.stableWindowFailureRate * 100).toFixed(2) + '%' : '—' }}</div>
                        <div class="history-detail-modal__kv-k">Window RPS</div>
                        <div class="history-detail-modal__kv-v rr-mono">{{ a.stableWindowRps != null ? a.stableWindowRps.toFixed(2) : '—' }}</div>
                        <div class="history-detail-modal__kv-k">Backoff steps</div>
                        <div class="history-detail-modal__kv-v rr-mono">{{ a.backoffSteps ?? '—' }}</div>
                      </div>
                    </div>
                  </div>
                </div>
              }
              }

              <div class="rr-card history-detail-modal__section">
                <div class="history-detail-modal__section-head">
                  <div class="history-detail-modal__section-title">Response Time Statistics</div>
                </div>
                <div class="history-detail-modal__table-wrap">
                  <table class="rr-table">
                    <thead>
                      <tr>
                        <th scope="col">Metric</th>
                        <th scope="col">Value</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>Average</td>
                        <td class="rr-mono">{{ m.averageResponseTime.toFixed(2) }}ms</td>
                      </tr>
                      <tr>
                        <td>50th Percentile (Median)</td>
                        <td class="rr-mono">{{ m.p50.toFixed(2) }}ms</td>
                      </tr>
                      <tr>
                        <td>95th Percentile</td>
                        <td class="rr-mono">{{ m.p95.toFixed(2) }}ms</td>
                      </tr>
                      <tr>
                        <td>99th Percentile</td>
                        <td class="rr-mono">{{ m.p99.toFixed(2) }}ms</td>
                      </tr>
                      <tr>
                        <td>Min</td>
                        <td class="rr-mono">{{ m.minResponseTime.toFixed(2) }}ms</td>
                      </tr>
                      <tr>
                        <td>Max</td>
                        <td class="rr-mono">{{ m.maxResponseTime.toFixed(2) }}ms</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="rr-card history-detail-modal__section">
                <div class="history-detail-modal__section-head">
                  <div class="history-detail-modal__section-title">Request Status</div>
                </div>

                <div class="history-detail-modal__status-grid">
                  <div class="rr-card rr-card--soft history-detail-modal__status-item">
                    <span>Successful</span>
                    <span class="history-detail-modal__status-value history-detail-modal__status-value--success rr-mono">{{ m.successfulRequests }}</span>
                  </div>
                  <div class="rr-card rr-card--soft history-detail-modal__status-item">
                    <span>Failed</span>
                    <span class="history-detail-modal__status-value history-detail-modal__status-value--error rr-mono">{{ m.failedRequests }}</span>
                  </div>
                  <div class="rr-card rr-card--soft history-detail-modal__status-item">
                    <span>Total</span>
                    <span class="history-detail-modal__status-value rr-mono">{{ m.totalRequests }}</span>
                  </div>
                </div>

                @if (m.failedRequests > 0 && m.failureStatusCounts && (m.failureStatusCounts | keyvalue).length > 0) {
                  <div class="rr-card rr-card--soft history-detail-modal__failbreak">
                    <div class="rr-card__kicker">Failure breakdown (status)</div>
                    <div class="history-detail-modal__table-wrap">
                      <table class="rr-table">
                        <thead>
                          <tr>
                            <th scope="col">Status</th>
                            <th scope="col">Count</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (kv of (m.failureStatusCounts | keyvalue); track kv.key) {
                            <tr>
                              <td class="rr-mono">{{ kv.key }}</td>
                              <td class="rr-mono">{{ kv.value }}</td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }

        @if (isLoadTest() && activeTab === 'raw') {
          <div id="tabpanel-raw" role="tabpanel" aria-labelledby="tab-raw" class="history-detail-modal__panel">
            <app-virtual-response-body [body]="getRawJson()" class="history-modal-body"></app-virtual-response-body>
          </div>
        }

        @if (!isLoadTest() && activeTab === 'body') {
          <div id="tabpanel-body" role="tabpanel" aria-labelledby="tab-body" class="history-detail-modal__panel">
            <app-virtual-response-body [body]="getFormattedResponse()" class="history-modal-body"></app-virtual-response-body>
          </div>
        }

        @if (activeTab === 'headers') {
          <div id="tabpanel-headers" role="tabpanel" aria-labelledby="tab-headers" class="history-detail-modal__panel">
            <div class="history-detail-modal__table-wrap">
              <table class="rr-table">
                <thead>
                  <tr>
                    <th scope="col" class="history-detail-modal__th--w33">Header</th>
                    <th scope="col">Value</th>
                  </tr>
                </thead>
                <tbody>
                  @for (kv of (item()!.responseData.headers | keyvalue); track kv.key) {
                    <tr>
                      <td class="rr-mono history-detail-modal__header-key">{{ kv.key }}</td>
                      <td class="rr-mono history-detail-modal__header-value">{{ kv.value }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        }
      </div>

      <div class="rr-modal__footer">
        <button type="button" class="rr-btn" (click)="onClose.emit()">Close</button>
      </div>
    </div>
  </div>
  <div class="rr-modal-backdrop modal-backdrop-animated" (click)="onClose.emit()"></div>
}