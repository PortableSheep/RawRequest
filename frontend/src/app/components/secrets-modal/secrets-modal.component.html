@if (isOpen()) {
  <div class="rr-modal-shell" (click)="handleShellClick($event)">
    <div class="rr-modal secrets-modal modal-animated" (click)="$event.stopPropagation()" role="dialog" aria-modal="true" aria-labelledby="secrets-modal-title">
      <div class="rr-modal__header">
        <h5 id="secrets-modal-title" class="rr-modal__title">
          <span class="secrets-modal__title-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          </span>
          Secrets
        </h5>
        <button type="button" class="rr-icon-btn rr-modal__close" (click)="onClose.emit()" aria-label="Close modal">
          <svg xmlns="http://www.w3.org/2000/svg" class="rr-icon rr-icon--md" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6L6 18M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="rr-modal__body secrets-modal__body">
        <!-- Add New Secret Form -->
        <div class="secrets-modal__add-row">
          <input
            type="text"
            class="rr-input secrets-modal__input-key"
            [(ngModel)]="newKey"
            placeholder="Secret key (e.g. api_key)"
            (keydown.enter)="handleSave()"
          >
          <div class="secrets-modal__value-wrap">
            <input
              [type]="showValue ? 'text' : 'password'"
              class="rr-input secrets-modal__input-value"
              [(ngModel)]="newValue"
              placeholder="Secret value"
              (keydown.enter)="handleSave()"
            >
            <button
              type="button"
              class="rr-icon-btn secrets-modal__toggle-visibility"
              (click)="toggleShowValue()"
              [attr.aria-label]="showValue ? 'Hide value' : 'Show value'"
              [title]="showValue ? 'Hide' : 'Show'"
            >
              @if (showValue) {
                <svg xmlns="http://www.w3.org/2000/svg" class="rr-icon rr-icon--sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                  <line x1="1" y1="1" x2="23" y2="23"/>
                </svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" class="rr-icon rr-icon--sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              }
            </button>
          </div>
          <select class="rr-input secrets-modal__select-env" [(ngModel)]="targetEnv" aria-label="Environment">
            <option value="">Global</option>
            @for (env of environments(); track env) {
              <option [value]="env">{{ env }}</option>
            }
          </select>
          <button class="rr-btn rr-btn--primary secrets-modal__add-btn" (click)="handleSave()" [disabled]="!newKey || !newValue">
            Add
          </button>
        </div>

        <div class="secrets-modal__hint">
          Use in requests: <code class="secrets-modal__hint-code">{{'{{secret:your_key}}'}}</code>
        </div>

        <!-- Secrets List -->
        <div class="secrets-modal__list">
          @if (getTotalSecretCount() === 0) {
            <div class="secrets-modal__empty">
              <svg xmlns="http://www.w3.org/2000/svg" class="rr-icon rr-icon--lg secrets-modal__empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
              </svg>
              <span>No secrets yet</span>
            </div>
          } @else {
            <div class="secrets-modal__table-header">
              <span class="secrets-modal__col-key">Key</span>
              <span class="secrets-modal__col-env">Environment</span>
              <span class="secrets-modal__col-actions"></span>
            </div>
            <div class="secrets-modal__table-body">
              @for (item of getFlatSecretList(); track item.env + ':' + item.key) {
                <div class="secrets-modal__row">
                  <code class="secrets-modal__cell-key" [title]="item.key">{{ item.key }}</code>
                  <span class="secrets-modal__cell-env">
                    <span class="secrets-modal__env-badge" [class.secrets-modal__env-badge--global]="item.env === 'default'">
                      {{ item.env === 'default' ? 'Global' : item.env }}
                    </span>
                  </span>
                  <span class="secrets-modal__cell-actions">
                    <button
                      class="rr-icon-btn rr-icon-btn--danger secrets-modal__delete-btn"
                      (click)="onDeleteClick.emit({env: item.env, key: item.key})"
                      title="Delete"
                      aria-label="Delete secret {{ item.key }}"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" class="rr-icon rr-icon--sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                      </svg>
                    </button>
                  </span>
                </div>
              }
            </div>
          }
        </div>

        <!-- Footer Actions -->
        <details class="secrets-modal__advanced">
          <summary class="secrets-modal__advanced-summary">
            <span>Advanced</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="rr-icon rr-icon--sm secrets-modal__chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </summary>
          <div class="secrets-modal__advanced-body">
            <div class="secrets-modal__advanced-row">
              <div class="secrets-modal__advanced-info">
                @if (vaultInfo()) {
                  <span class="secrets-modal__vault-stat">
                    <strong>{{ vaultInfo()!.secretCount }}</strong> secrets in <strong>{{ vaultInfo()!.envCount }}</strong> environments
                  </span>
                  <span class="secrets-modal__vault-stat secrets-modal__vault-stat--muted">
                    Storage: {{ vaultInfo()!.keySource }}
                  </span>
                }
              </div>
              <div class="secrets-modal__advanced-actions">
                <button class="rr-btn rr-btn--sm" (click)="triggerExport()" title="Export all secrets as JSON">
                  Export
                </button>
                <button
                  class="rr-btn rr-btn--sm rr-btn--danger"
                  (click)="confirmReset()"
                  title="Delete all secrets"
                >
                  Reset All
                </button>
              </div>
            </div>
          </div>
        </details>
      </div>
    </div>
  </div>
  <div class="rr-modal-backdrop modal-backdrop-animated" (click)="onClose.emit()"></div>
}

<!-- Reset Confirmation Overlay -->
@if (showResetConfirm) {
  <div class="rr-modal-shell secrets-modal__confirm-shell" style="z-index: 1001">
    <div class="rr-modal secrets-modal__confirm modal-animated" role="alertdialog" aria-modal="true" aria-labelledby="reset-confirm-title">
      <div class="rr-modal__header">
        <h5 id="reset-confirm-title" class="rr-modal__title">
          <svg xmlns="http://www.w3.org/2000/svg" class="rr-icon rr-icon--warning" style="vertical-align: middle; margin-right: 6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          Reset All Secrets?
        </h5>
      </div>
      <div class="rr-modal__body">
        <p>This will permanently delete <strong>all secrets</strong> from your device. This cannot be undone.</p>
        <div class="secrets-modal__confirm-field">
          <label class="rr-label">Type <strong>RESET</strong> to confirm:</label>
          <input
            type="text"
            class="rr-input"
            [(ngModel)]="resetConfirmText"
            placeholder="RESET"
            autocomplete="off"
            spellcheck="false"
            (keydown.enter)="isResetEnabled && executeReset()"
          >
        </div>
      </div>
      <div class="rr-modal__footer">
        <button class="rr-btn" (click)="cancelReset()">Cancel</button>
        <button class="rr-btn rr-btn--danger" [disabled]="!isResetEnabled" (click)="executeReset()">
          Delete All Secrets
        </button>
      </div>
    </div>
  </div>
  <div class="rr-modal-backdrop modal-backdrop-animated" style="z-index: 1000" (click)="cancelReset()"></div>
}
