<div class="rr-app">
    <app-header
            [files]="filesSignal()"
            [currentFileIndex]="currentFileIndexSignal()"
            [environments]="getEnvironments()"
            [selectedEnv]="currentEnv()"
            [appVersion]="updateService.appVersion()"
            (onFileSelect)="switchToFile($event)"
            (onNewFile)="addNewTab()"
            (onOpenFile)="openFile()"
            (onSaveFile)="saveCurrentFile()"
            (onSaveFileAs)="saveCurrentFileAs()"
            (onOpenExamples)="openExamplesFile()"
            (onCloseFile)="closeTab($event)"
            (onEnvChange)="onCurrentEnvChange($event)"
            (onSecretsClick)="openSecretsModal()"
            (onDonateClick)="showDonationModal = true"
            (onHistoryClick)="toggleHistory()"
            (onReorderTabs)="onTabsReordered($event)"
            (onRevealInFinder)="revealInFinder($event)"
            (onCloseOtherTabs)="closeOtherTabs($event)">
    </app-header>

    <main class="rr-app__main">
        <div class="rr-shell">
            <app-request-manager
                    [files]="filesSignal()"
                    [currentFileIndex]="currentFileIndexSignal()"
                    [currentEnv]="currentEnv()"
                    (filesChange)="onFilesChange($event)"
                    (currentFileIndexChange)="onCurrentFileIndexChange($event)"
                    (currentEnvChange)="onCurrentEnvChange($event)"
                    (requestExecuted)="onRequestExecuted($event)"
                    (requestProgress)="onRequestProgress($event)"
                    (historyUpdated)="onHistoryUpdated($event)">
            </app-request-manager>

            <div
                #mainSplit
                class="rr-split"
                [style.gridTemplateColumns]="splitGridTemplateColumns"
            >
                <div class="glass-panel glass-panel--static rr-panel rr-panel--accent-blue rr-main-pane rr-main-pane--left">
                    <div class="rr-panel__header">
                        <span class="rr-panel__header-label">Editor</span>
                        <button
                            type="button"
                            class="rr-btn rr-btn--ghost"
                            (click)="openSnippetModal()"
                            title="Insert script snippet"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="rr-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
                            <span>Snippets</span>
                        </button>
                    </div>
                    <app-editor
                        #editorComponent
                        class="rr-panel__body"
                        [content]="currentFileView().content"
                        [requests]="currentFileView().requests"
                        [variables]="currentFileView().variables"
                        [environments]="currentFileView().environments"
                        [currentEnv]="currentEnv()"
                        [secrets]="allSecrets"
                        [requestNames]="currentFileRequestNames()"
                        [executingRequestIndex]="pendingRequestIndexSignal()"
                        [isBusy]="isRequestRunningSignal()"
                        (contentChange)="onEditorContentChange($event)"
                        (requestExecute)="onRequestExecute($event)">
                    </app-editor>
                </div>

                @if (isSplitLayout) {
                    <div
                        class="rr-split__separator"
                        (mousedown)="onSplitMouseDown($event)"
                        (dblclick)="resetSplit()"
                        title="Drag to resize (double-click to reset)"
                        role="separator"
                        aria-orientation="vertical"
                        [attr.aria-valuenow]="editorPaneWidthPx"
                    >
                        <div class="rr-split__separator-handle">
                            <div class="rr-split__separator-line"></div>
                        </div>
                    </div>
                }

                <div class="glass-panel glass-panel--static rr-panel rr-panel--accent-emerald rr-main-pane rr-main-pane--right">
                    <app-response-panel
                        class="rr-panel__body"
                        [responseData]="lastExecutedRequestIndexSignal() !== null ? currentFileView().responseData[lastExecutedRequestIndexSignal()!] : null"
                        [request]="lastExecutedRequestIndexSignal() !== null ? currentFileView().requests[lastExecutedRequestIndexSignal()!] : null"
                        [isLoading]="isRequestRunningSignal()"
                        [isCancelling]="isCancellingActiveRequest"
                        [downloadProgress]="downloadProgressSignal()"
                        (replayRequest)="onReplayRequest($event)">
                    </app-response-panel>
                </div>
            </div>
        </div>

        @if (activeRequestInfo; as active) {
            @let activeRequest = getActiveRequestDetails();
            <div class="rr-active-overlay" style="bottom: calc(var(--rr-console-offset, 0px) + 5rem);">
                <div class="glass-panel floating-overlay rr-active-card">
                    <div class="rr-active-card__top">
                        <div class="rr-active-card__title">
                            <span
                                class="rr-active-dot"
                                [class.rr-active-dot--cancelling]="isCancellingActiveRequest"
                            ></span>
                            <div>
                                <p class="rr-active-card__label">{{ active?.label }}</p>
                                <small class="rr-active-card__meta">{{ getActiveRequestMeta() }}</small>
                            </div>
                        </div>
                        <button
                            type="button"
                            class="rr-btn rr-btn--pill rr-btn--danger btn-ambient"
                            (click)="cancelActiveRequest()"
                            [disabled]="!active.canCancel || isCancellingActiveRequest"
                        >
                            {{ isCancellingActiveRequest ? 'Canceling...' : 'Cancel request' }}
                        </button>
                    </div>

                    <div class="rr-active-card__details">
                        <div class="rr-active-card__details-top">
                            <span class="rr-pill rr-pill--method">
                                {{ activeRequest?.method || '—' }}
                            </span>
                            <span class="rr-active-card__status">
                                {{ active.type === 'load' ? 'Load test running' : active.type === 'chain' ? 'Chained request running' : 'Request running' }}
                            </span>
                        </div>

                        @if (active.type === 'load') {
                            <div class="rr-active-row">
                                <div class="rr-active-row__label">Users</div>
                                <svg viewBox="0 0 100 20" preserveAspectRatio="none" class="rr-active-row__spark">
                                                            <defs>
                                                                <clipPath id="usersSparklineClip">
                                                                    <rect x="0" y="0" width="100" height="20"></rect>
                                                                </clipPath>
                                                            </defs>
                                                            <g [attr.transform]="loadUsersSparklineTransformView || null" [attr.clip-path]="'url(#usersSparklineClip)'">
                                                                <path
                                                                    [attr.d]="loadUsersSparklinePathDView"
                                                                    fill="none"
                                                                    stroke="currentColor"
                                                                    stroke-width="1.5"
                                                                    stroke-linecap="round"
                                                                    stroke-linejoin="round"
                                                                    class="rr-color-primary"
                                                                ></path>
                                                            </g>
                                                        </svg>
                                <div class="rr-active-row__value">
                                    {{ activeRunProgressView?.activeUsers ?? 0 }}/{{ activeRunProgressView?.maxUsers ?? '—' }}
                                </div>
                            </div>

                            <div class="rr-active-row">
                                <div class="rr-active-row__label">RPS</div>
                                <svg viewBox="0 0 100 20" preserveAspectRatio="none" class="rr-active-row__spark">
                                                            <defs>
                                                                <clipPath id="rpsSparklineClip">
                                                                    <rect x="0" y="0" width="100" height="20"></rect>
                                                                </clipPath>
                                                            </defs>
                                                            <g [attr.transform]="loadRpsSparklineTransformView || null" [attr.clip-path]="'url(#rpsSparklineClip)'">
                                                                <path
                                                                    [attr.d]="loadRpsSparklinePathDView"
                                                                    fill="none"
                                                                    stroke="currentColor"
                                                                    stroke-width="1.5"
                                                                    stroke-linecap="round"
                                                                    stroke-linejoin="round"
                                                                    class="rr-color-accent"
                                                                ></path>
                                                            </g>
                                                        </svg>
                                <div class="rr-active-row__value">
                                    {{ currentLoadRpsView | number:'1.0-0' }}
                                </div>
                            </div>
                        }

                        <div class="rr-active-card__name">
                            {{ activeRequest?.name || 'Waiting for request selection' }}
                        </div>
                        <pre class="rr-active-card__preview"><code>{{ getActiveRequestPreview() }}</code></pre>
                    </div>
                </div>
            </div>
        }
    </main>

    <app-console-drawer
            [open]="consoleOpen()"
            [logs]="scriptLogs()"
            [latestLog]="latestConsoleEntry()"
            [status]="footerStatus()"
            (onToggle)="toggleConsole()"
            (onClear)="clearConsole()">
    </app-console-drawer>
   <app-history-sidebar
        [isOpen]="showHistory"
        [history]="history"
        [selectedItem]="selectedHistoryItem"
        (onClose)="toggleHistory()"
        (onItemClick)="viewHistory($event)">
   </app-history-sidebar>
   <app-history-detail-modal
        [isOpen]="showHistoryModal"
        [item]="selectedHistoryItem"
        (onClose)="closeHistoryModal()">
    </app-history-detail-modal>
    <app-load-test-results-modal
        [isOpen]="showLoadTestResults"
        [metrics]="loadTestMetrics"
        (onClose)="closeLoadTestResults()">
    </app-load-test-results-modal>
    <app-donation-modal
        [isOpen]="showDonationModal"
        (onClose)="showDonationModal = false"
        (onDonate)="donate($event)">
    </app-donation-modal>
    <app-secrets-modal
        [isOpen]="showSecretsModal"
        [selectedEnv]="currentEnv()"
        [environments]="getEnvironments()"
        [allSecrets]="allSecrets"
        [vaultInfo]="vaultInfo"
        (onClose)="showSecretsModal = false"
        (onSave)="handleSecretSave($event)"
        (onDeleteClick)="confirmDeleteSecret($event.env, $event.key)"
        (onExport)="handleVaultExport()"
        (onResetVault)="handleVaultReset()">
    </app-secrets-modal>

    <!-- Delete Confirm Modal Component -->
    <app-delete-confirm-modal
        [isOpen]="showDeleteConfirmModal"
        [secretInfo]="secretToDelete"
        (onConfirm)="deleteSecret()"
        (onCancel)="cancelDeleteSecret()">
    </app-delete-confirm-modal>

    <!-- Toast Container -->
    <app-toast-container></app-toast-container>

    <!-- Update Notification -->
    <app-update-notification></app-update-notification>

    <!-- Script Snippet Modal -->
    <app-script-snippet-modal
        #snippetModal
        (snippetSelected)="onSnippetSelected($event)"
        (closed)="showSnippetModal = false">
    </app-script-snippet-modal>
</div>
