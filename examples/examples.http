# RawRequest - Complete Feature Demonstration
# This file showcases ALL features supported by RawRequest
# Use this as a reference guide and testing playground

@tab RawRequest Examples

###############################################################################
# 1. ENVIRONMENT VARIABLES
###############################################################################
# Define environment-specific variables using @env.<envName>.<variableName>
# These are accessible via {{variableName}} in requests
# Switch environments using the dropdown in the header

# Default env is what RawRequest starts with. Keep it runnable out-of-the-box.
@env.default.baseUrl https://httpbun.com
@env.default.apiKey demo-api-key
@env.default.timeout 30000

@env.local.baseUrl http://localhost:3000
@env.local.apiKey local-api-key-12345
@env.local.timeout 30000

@env.dev.baseUrl https://dev-api.example.com
@env.dev.apiKey dev-api-key-67890
@env.dev.timeout 60000

@env.test.baseUrl https://test-api.example.com
@env.test.apiKey test-api-key-abcde
@env.test.timeout 60000

@env.stage.baseUrl https://stage-api.example.com
@env.stage.apiKey stage-api-key-fghij
@env.stage.timeout 90000

@env.prod.baseUrl https://api.example.com
@env.prod.apiKey prod-api-key-klmno
@env.prod.timeout 120000

###############################################################################
# 2. GLOBAL VARIABLES
###############################################################################
# Variables available across all environments
# NOTE: Pre-defining variables is OPTIONAL! You can use setVar() in scripts
# to create new variables dynamically without declaring them here first.
# These declarations are useful for:
#   - Documentation purposes
#   - Setting default/initial values
#   - Autocomplete suggestions in the editor

@apiVersion = v1
@contentType = application/json
@userAgent = RawRequest/1.0
@baseUrl = https://httpbun.com
@apiKey = demo-api-key
@token = demo-token
@userName = john
@userEmail = john@example.com
@userId =
@sessionId =
@requestId =
@timestamp =
@date =
@resourceId =
@randomId =
@unixTime =
@uuid =
@checkoutSessionId =
@transactionId =
@cartTotal = 0
@finalTotal = 0
@helperStart =

###############################################################################
# 3. BASIC HTTP METHODS
###############################################################################

### Simple GET request
GET https://httpbun.com/get
User-Agent: {{userAgent}}
Date: {{date}}

< {
  setVar('date', new Date().toUTCString());
}

### GET with environment variable
GET {{baseUrl}}/api/{{apiVersion}}/status
Accept: {{contentType}}

### POST with JSON body
POST https://httpbun.com/post
Content-Type: {{contentType}}
User-Agent: {{userAgent}}

{
  "message": "Hello from RawRequest",
  "timestamp": "2024-01-15T10:30:00Z",
  "version": "{{apiVersion}}"
}

### PUT request
PUT https://httpbun.com/put
Content-Type: application/json

{
  "id": 123,
  "status": "updated"
}

### DELETE request
DELETE https://httpbun.com/delete
Authorization: Bearer fake-token

### PATCH request
PATCH https://httpbun.com/patch
Content-Type: application/json

{
  "field": "value"
}

### HEAD request (gets headers only, no body)
HEAD https://httpbun.com/get

### OPTIONS request (check available methods)
OPTIONS https://httpbun.com/get

###############################################################################
# 4. REQUEST CHAINING & DEPENDENCIES
###############################################################################
# Use @name to identify requests and @depends to create dependencies
# Chain icon (ðŸ”—) appears in the gutter for dependent requests

### Login - Sets authentication token
@name login
POST https://httpbun.com/post
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123"
}

< {
  // Pre-request script: runs before the request
  console.log('Attempting login...');
  setVar('loginTime', Date.now());
}

> {
  // Post-request script: runs after the request
  const fakeToken = 'Bearer jwt-token-' + Math.random().toString(36).substr(2, 9);
  setVar('token', fakeToken);
  console.log('Login successful! Token:', getVar('token'));

  // Simulate extracting user data from response
  setVar('userId', 'user-' + Math.floor(Math.random() * 1000));
}

### Get User Profile - Depends on login
@name getUserProfile
@depends login
GET https://httpbun.com/get
Authorization: {{token}}
Accept: application/json

> {
  // Extract data from response
  console.log('User profile retrieved for:', getVar('userId'));
  setVar('userEmail', 'user@example.com');
  setVar('userName', 'Test User');
}

### Update User Profile - Depends on getUserProfile
@name updateProfile
@depends getUserProfile
PUT https://httpbun.com/put
Authorization: {{token}}
Content-Type: application/json

{
  "userId": "{{userId}}",
  "email": "{{userEmail}}",
  "name": "{{userName}}",
  "updatedAt": "2024-01-15T10:30:00Z"
}

> {
  console.log('Profile updated successfully!');
  setVar('profileUpdated', true);
}

###############################################################################
# 5. PRE & POST SCRIPTS
###############################################################################
# Use < for pre-request scripts and > for post-request scripts

### Request with pre-script
@name scriptDemo
GET https://httpbun.com/delay/1

< {
  // Pre-script: Set variables, prepare data
  setVar('requestStartTime', Date.now());
  setVar('requestId', 'req-' + Math.random().toString(36).substr(2, 9));
  console.log('Starting request:', getVar('requestId'));
}

> {
  // Post-script: Process response, store data
  const duration = Date.now() - getVar('requestStartTime');
  console.log('Request completed in', duration, 'ms');
  setVar('lastResponseTime', duration);

  if (response.status === 200) {
    setVar('lastRequestSuccess', true);
    console.log('Success! Status:', response.status);
  } else {
    setVar('lastRequestSuccess', false);
    console.error('Failed with status:', response.status);
  }
}

###############################################################################
# 6. ASSERTIONS
###############################################################################
# Validate response status, headers, and body

### Request with assertions
@name assertionDemo
GET https://httpbun.com/get

> {
  assert(response.status === 200, `Expected status 200, got ${response.status}`);

  const contentType = String(response.headers?.['content-type'] ?? response.headers?.['Content-Type'] ?? '');
  assert(contentType.includes('application/json'), `Expected Content-Type to include application/json, got ${contentType}`);

  const responseUrl = String(response.json?.url ?? '');
  assert(responseUrl.includes('httpbun.com/get'), `Expected response.json.url to include httpbun.com/get, got ${responseUrl}`);
}

###############################################################################
# 7. LOAD TESTING
###############################################################################
# Use @load to configure load tests
# Lightning icon (âš¡) appears in the gutter for load test requests

# RawRequest load testing is intentionally "Locust-ish": it supports core knobs like
# users/concurrency, spawn rate/ramp-up, wait time (think time), duration vs total
# request count, and an optional global RPS cap.
#
# Supported @load keys (canonical + common aliases):
#   - Concurrency: concurrent, users, concurrency
#   - Total requests: iterations, amount, requests, count
#   - Duration: duration, runtime, time
#   - Ramp/spawn: start, max, rampUp, spawnRate
#   - Wait/think time: delay, waitMin, waitMax
#   - Throughput cap: requestsPerSecond, rps
#
# Notes:
#   - If neither duration nor iterations/amount is provided, RawRequest defaults to 10 total requests.
#   - "delay" is a fixed per-user pause between requests.
#   - "waitMin/waitMax" enables a random per-user pause (uniform) between requests.
#   - "failureRateThreshold" aborts the run early once total failure rate exceeds the threshold.
#   - Adaptive mode: ramp up, detect failures in a sliding window, back off until stable, then stop.
#     (See the examples below.)

### Basic load test (Locust-style: users + duration)
@name loadTestBasic
@load users=5 duration=10s
GET https://httpbun.com/get

### Total request count (alias: amount) + concurrency (alias: concurrency)
@name loadTestIterations
@load concurrency=10 amount=100
GET https://httpbun.com/delay/1

### Ramp users over time using spawn rate (users/sec)
@name loadTestAdvanced
@load start=1 max=20 spawnRate=4 duration=20s
POST https://httpbun.com/post
Content-Type: application/json

{
  "testData": "load-test-payload"
}

### Ramp users using rampUp duration (spawnRate derived automatically)
@name loadTestRampUpDuration
@load start=2 max=25 rampUp=10s duration=25s
GET https://httpbun.com/get

### Wait/think time (random per-user wait between requests)
@name loadTestWaitRange
@load users=10 duration=20s waitMin=100ms waitMax=500ms
GET https://httpbun.com/get

### Fixed delay between requests (per-user pacing)
@name loadTestDelay
@load users=8 duration=15s delay=250ms
GET https://httpbun.com/get

### Global RPS cap (alias: rps) with concurrent users
@name loadTestRate
@load users=25 duration=20s rps=30
GET https://httpbun.com/get

### Early abort on failure-rate threshold
@name loadTestAbortOnFailureRate
@load users=10 duration=30s failureRateThreshold=5%
GET https://httpbun.com/status/503

### Adaptive backoff (ramp up, then back off until stable, then stop)
@name loadTestAdaptiveBackoff
@load start=1 max=50 spawnRate=5 duration=2m rps=100 \
  adaptive=true adaptiveFailureRate=1% adaptiveWindow=15s adaptiveStable=20s adaptiveCooldown=5s adaptiveBackoffStep=2
GET https://httpbun.com/delay/1

###############################################################################
# 8. SECRETS USAGE
###############################################################################
# Use {{secret:keyName}} to reference encrypted secrets

### Request using secrets
@name secretDemo
GET https://httpbun.com/get
# To try secrets:
# 1) Open the Secrets modal
# 2) Add secrets for the active environment:
#    - api_token
#    - api_secret
#    - client_id
# 3) Uncomment the three headers below
# Authorization: Bearer {{secret:api_token}}
# X-API-Key: {{secret:api_secret}}
# X-Client-ID: {{secret:client_id}}

# Out-of-box runnable defaults (non-secret)
Authorization: Bearer {{token}}
X-API-Key: {{apiKey}}
X-Client-ID: client-demo

###############################################################################
# 9. COMPLEX WORKFLOWS
###############################################################################
# Combine multiple features for complex API workflows

### Step 1: Initialize session
@name initSession
POST https://httpbun.com/post
Content-Type: application/json

{
  "action": "init_session"
}

> {
  setVar('sessionId', 'sess-' + Math.random().toString(36).substr(2, 12));
  console.log('Session initialized:', getVar('sessionId'));
}

### Step 2: Create resource
@name createResource
@depends initSession
POST https://httpbun.com/post
Content-Type: application/json
X-Session-ID: {{sessionId}}

{
  "type": "document",
  "name": "Test Document",
  "content": "This is a test document created via RawRequest"
}

> {
  const resourceId = 'res-' + Math.random().toString(36).substr(2, 9);
  setVar('resourceId', resourceId);
  console.log('Resource created:', resourceId);
}

### Step 3: Read resource
@name readResource
@depends createResource
GET https://httpbun.com/get?id={{resourceId}}
X-Session-ID: {{sessionId}}

> {
  console.log('Resource retrieved:', getVar('resourceId'));
  setVar('resourceData', JSON.stringify(response.json));
}

### Step 4: Update resource
@name updateResource
@depends readResource
PUT https://httpbun.com/put
Content-Type: application/json
X-Session-ID: {{sessionId}}

{
  "id": "{{resourceId}}",
  "content": "Updated content",
  "version": 2
}

> {
  console.log('Resource updated successfully');
}

### Step 5: Delete resource
@name deleteResource
@depends updateResource
DELETE https://httpbun.com/delete?id={{resourceId}}
X-Session-ID: {{sessionId}}

> {
  console.log('Workflow completed - resource deleted');
  console.log('Session:', getVar('sessionId'));
}

###############################################################################
# 10. ERROR HANDLING
###############################################################################

### Handle 404 error
@name handle404
GET https://httpbun.com/status/404

> {
  if (response.status === 404) {
    console.error('Resource not found');
    setVar('hasError', true);
  }
}

### Handle 500 error
@name handle500
GET https://httpbun.com/status/500

> {
  if (response.status >= 500) {
    console.error('Server error:', response.status);
    setVar('serverError', true);
  }
}

###############################################################################
# 11. GRAPHQL REQUESTS
###############################################################################

### GraphQL query
@name graphqlQuery
POST https://httpbun.com/post
Content-Type: application/json
X-Request-Type: GraphQL

{
  "query": "query GetUser($id: ID!) { user(id: $id) { id name email posts { title } } }",
  "variables": {
    "id": "123"
  }
}

### GraphQL mutation
@name graphqlMutation
POST https://httpbun.com/post
Content-Type: application/json

{
  "query": "mutation CreatePost($input: PostInput!) { createPost(input: $input) { id title createdAt } }",
  "variables": {
    "input": {
      "title": "New Post",
      "content": "Post content here"
    }
  }
}

###############################################################################
# 12. FILE UPLOAD (MULTIPART)
###############################################################################

### Upload file with multipart/form-data
@name fileUpload
POST https://httpbun.com/post
Content-Type: multipart/form-data; boundary=boundary123

--boundary123
Content-Disposition: form-data; name="file"; filename="document.txt"
Content-Type: text/plain

This is the file content that will be uploaded.
It can span multiple lines.

--boundary123
Content-Disposition: form-data; name="metadata"
Content-Type: application/json

{
  "uploadedBy": "{{userId}}",
  "timestamp": "2024-01-15T10:30:00Z",
  "description": "Test file upload"
}

--boundary123
Content-Disposition: form-data; name="category"

documents
--boundary123--

###############################################################################
# 13. CUSTOM HEADERS & AUTHENTICATION
###############################################################################

### Basic Authentication
@name basicAuth
GET https://httpbun.com/basic-auth/user/passwd
### group: Authentication ###
Authorization: Basic dXNlcjpwYXNzd2Q=

### Bearer Token Authentication
@name bearerAuth
GET https://httpbun.com/bearer
Authorization: Bearer {{token}}

### API Key Authentication
@name apiKeyAuth
GET https://httpbun.com/get
X-API-Key: {{apiKey}}
X-Client-ID: client-123

### Custom Headers
@name customHeaders
GET https://httpbun.com/headers
User-Agent: {{userAgent}}
X-Custom-Header: custom-value
X-Request-ID: {{requestId}}
X-Correlation-ID: corr-{{sessionId}}
Accept-Language: en-US,en;q=0.9
Cache-Control: no-cache

###############################################################################
# 14. DIFFERENT CONTENT TYPES
###############################################################################

### JSON request
@name jsonRequest
POST https://httpbun.com/post
Content-Type: application/json

{
  "key": "value",
  "nested": {
    "array": [1, 2, 3]
  }
}

### XML request
@name xmlRequest
POST https://httpbun.com/post
Content-Type: application/xml

# Note: The echo service responds with JSON; your XML payload is preserved verbatim
# and returned as a string (typically under a field like "data"), not parsed into a structure.

<?xml version="1.0" encoding="UTF-8"?>
<request>
  <action>test</action>
  <data>
    <item>value1</item>
    <item>value2</item>
  </data>
</request>

### Form URL encoded
@name formRequest
POST https://httpbun.com/post
Content-Type: application/x-www-form-urlencoded

name=John+Doe&email=john@example.com&age=30&subscribe=true

### Plain text request
@name textRequest
POST https://httpbun.com/post
Content-Type: text/plain

This is plain text content.
It can span multiple lines.

###############################################################################
# 15. QUERY PARAMETERS & DYNAMIC URLS
###############################################################################

### URL with query parameters
@name queryParams
GET https://httpbun.com/get?search={{userName}}&page=1&limit=10&sort=desc

### Dynamic URL construction
@name dynamicUrl
GET {{baseUrl}}/api/{{apiVersion}}/users/{{userId}}/profile?include=posts,comments

###############################################################################
# 16. TESTING & DEBUGGING
###############################################################################

### Timeout override (per-request)
# This uses the @timeout directive (milliseconds) to override the request timeout.
# With a 1s timeout against a 2s delay endpoint, this should time out.
@name timeoutOverride
@timeout 1000
GET https://httpbun.com/delay/2

### Debug request with logging
@name debugRequest
GET https://httpbun.com/get

< {
  console.log('=== DEBUG REQUEST ===');
  console.log('Base URL:', getVar('baseUrl'));
  console.log('User ID:', getVar('userId'));
  console.log('Token:', getVar('token'));
  console.log('Session ID:', getVar('sessionId'));
}

> {
  console.log('=== DEBUG RESPONSE ===');
  console.log('Status:', response.status);
  setVar('lastResponseTime', String(response.responseTime || 0));
  console.log('Response time:', getVar('lastResponseTime'), 'ms');
  console.log('Response body:', JSON.stringify(response.json, null, 2));
}

### Performance test
@name performanceTest
GET https://httpbun.com/delay/2

< {
  setVar('perfStartTime', Date.now());
}

> {
  const duration = Date.now() - getVar('perfStartTime');
  console.log('Request took:', duration, 'ms');

  if (duration > 3000) {
    console.warn('Request took longer than 3 seconds!');
  }
}

###############################################################################
# 17. DYNAMIC JAVASCRIPT EXPRESSIONS IN VARIABLES
###############################################################################
# Generate dynamic values in pre-request scripts, then interpolate variables

### Dynamic timestamp in request
@name dynamicData
POST https://httpbun.com/post
Content-Type: application/json

< {
  setVar('timestamp', new Date().toISOString());
  setVar('randomId', Math.random().toString(36).substr(2, 9));
  setVar('unixTime', String(Date.now()));
  setVar('uuid', 'id-' + Date.now() + '-' + Math.random().toString(16).slice(2));
}

{
  "timestamp": "{{timestamp}}",
  "randomId": "{{randomId}}",
  "unixTime": "{{unixTime}}",
  "uuid": "{{uuid}}"
}

###############################################################################
# 18. CONDITIONAL LOGIC IN SCRIPTS
###############################################################################

### Conditional execution
@name conditionalTest
GET https://httpbun.com/get

> {
  // Conditional variable setting
  if (response.status === 200) {
    setVar('healthStatus', 'healthy');
    console.log('âœ“ Service is healthy');
  } else if (response.status >= 500) {
    setVar('healthStatus', 'down');
    console.error('âœ— Service is down');
  } else {
    setVar('healthStatus', 'degraded');
    console.warn('âš  Service is degraded');
  }

  // Loop through response data
  if (response.json && response.json.headers) {
    console.log('Response headers:');
    for (const [key, value] of Object.entries(response.json.headers)) {
      console.log(`  ${key}: ${value}`);
    }
  }
}

###############################################################################
# 19. RESPONSE DATA EXTRACTION & MANIPULATION
###############################################################################

### Extract and transform data
@name dataExtraction
POST https://httpbun.com/post
Content-Type: application/json

< {
  // Capture start time so we can compute response time in the post-script.
  setVar('requestStartTime', String(Date.now()));
}

{
  "slideshow": {
    "title": "Sample Slide Show",
    "author": "Yours Truly",
    "date": "date of publication",
    "slides": [
      {
        "title": "Wake up to WonderWidgets!",
        "type": "all"
      },
      {
        "title": "Overview",
        "type": "all",
        "items": [
          "Why WonderWidgets are great",
          "Who buys WonderWidgets"
        ]
      }
    ]
  }
}

> {
  // Extract nested data.
  // Different echo services wrap request JSON differently, so handle common shapes.
  const data = response.json?.slideshow
    ? response.json
    : (response.json?.json || response.json?.data || response.json);

  // Store extracted values
  const slideshow = data?.slideshow;
  if (slideshow) {
    setVar('title', slideshow.title);
    setVar('author', slideshow.author);
    setVar('slides', JSON.stringify(slideshow.slides));

    // Manipulation: derive normalized/aggregated fields.
    const slides = Array.isArray(slideshow.slides) ? slideshow.slides : [];
    const slideTitles = slides
      .map((s) => String(s?.title || '').trim())
      .filter(Boolean);

    setVar('slideCount', String(slides.length));
    setVar('slideTitles', JSON.stringify(slideTitles));

    const totalBulletItems = slides.reduce((sum, s) => {
      return sum + (Array.isArray(s?.items) ? s.items.length : 0);
    }, 0);
    setVar('totalBulletItems', String(totalBulletItems));

    const authorSlug = String(slideshow.author || '')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)/g, '');
    setVar('authorSlug', authorSlug);
  }

  // Transform and store
  setVar('dataSize', JSON.stringify(data || {}).length);
  const startMs = Number(getVar('requestStartTime') || '0');
  const responseTimeMs = startMs ? Math.max(0, Date.now() - startMs) : 0;
  setVar('responseTimeMs', String(responseTimeMs));

  console.log('Extracted:', {
    title: getVar('title'),
    author: getVar('author'),
    slideCount: getVar('slideCount'),
    totalBulletItems: getVar('totalBulletItems'),
    authorSlug: getVar('authorSlug'),
    responseTimeMs: getVar('responseTimeMs'),
    size: getVar('dataSize') + ' bytes'
  });
}

###############################################################################
# 20. COMPREHENSIVE WORKFLOW - E-COMMERCE CHECKOUT
###############################################################################
# This demonstrates a complete multi-step workflow with all features combined

### Step 1: Initialize Shopping Session
@name initCheckout
POST https://httpbun.com/post
Content-Type: application/json

{
  "action": "init_checkout",
  "timestamp": "{{timestamp}}"
}

< {
  console.log('ðŸ›’ Starting checkout flow...');
  setVar('timestamp', new Date().toISOString());
  setVar('checkoutStartTime', Date.now());
}

> {
  const sessionId = 'checkout-' + Math.random().toString(36).substr(2, 12);
  setVar('checkoutSessionId', sessionId);
  console.log('Session initialized:', sessionId);
}

### Step 2: Add Items to Cart (depends on session)
@name addToCart
@depends initCheckout
POST https://httpbun.com/post
Content-Type: application/json
X-Session-ID: {{checkoutSessionId}}

{
  "items": [
    {"productId": "prod-123", "quantity": 2, "price": 29.99},
    {"productId": "prod-456", "quantity": 1, "price": 49.99}
  ],
  "sessionId": "{{checkoutSessionId}}"
}

> {
  const items = JSON.parse(request.body).items;
  const total = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  setVar('cartTotal', total);
  console.log('Cart total: $' + total.toFixed(2));
}

### Step 3: Apply Discount Code
@name applyDiscount
@depends addToCart
POST https://httpbun.com/post
Content-Type: application/json
X-Session-ID: {{checkoutSessionId}}

{
  "discountCode": "SAVE20",
  "cartTotal": {{cartTotal}}
}

> {
  const discount = getVar('cartTotal') * 0.20;
  const finalTotal = getVar('cartTotal') - discount;
  setVar('discount', discount);
  setVar('finalTotal', finalTotal);
  console.log('Discount applied: -$' + discount.toFixed(2));
  console.log('Final total: $' + finalTotal.toFixed(2));
}

### Step 4: Process Payment
@name processPayment
@depends applyDiscount
POST https://httpbun.com/post
Content-Type: application/json
X-Session-ID: {{checkoutSessionId}}
Authorization: Bearer {{token}}

{
  "amount": {{finalTotal}},
  "currency": "USD",
  "paymentMethod": "card_test_12345",
  "sessionId": "{{checkoutSessionId}}"
}

> {
  if (response.status === 200) {
    const transactionId = 'txn-' + Math.random().toString(36).substr(2, 16);
    setVar('transactionId', transactionId);
    console.log('âœ“ Payment successful! Transaction:', transactionId);
  } else {
    console.error('âœ— Payment failed:', response.status);
    throw new Error('Payment processing failed');
  }
}

### Step 5: Script helper & console showcase (optional)
@name helperShowcase
@depends processPayment
GET https://httpbun.com/any

< {
  return (async () => {
    console.log('ðŸ§° Helper demo starting...');

    // Dynamically tweak the outbound request without editing the HTTP block
    updateRequest({
      url: `https://httpbun.com/any/helpers/${Date.now()}`,
      headers: {
        'X-Helper-Demo': 'true',
        'X-Workflow-Stage': 'post-payment'
      }
    });

    // Inject/override a single header on the fly
    setHeader('X-Session-ID', getVar('checkoutSessionId'));

    setVar('helperStart', Date.now());
    console.info('Waiting 250ms to simulate downstream dependency...');
    await delay(250);
  })();
}

> {
  // Guarantee happy-path behavior
  assert(response.status === 200, 'Helper showcase should return 200');

  const duration = Date.now() - getVar('helperStart');
  console.log('Helper request finished in', duration, 'ms');
  console.log('Console output is visible live inside the Script Console tray.');
}

### Step 6: Send Confirmation Email
@name sendConfirmation
@depends processPayment
POST https://httpbun.com/post
Content-Type: application/json

< {
  setVar('timestamp', new Date().toISOString());
}

{
  "to": "customer@example.com",
  "subject": "Order Confirmation",
  "orderId": "{{checkoutSessionId}}",
  "transactionId": "{{transactionId}}",
  "amount": {{finalTotal}},
  "timestamp": "{{timestamp}}"
}

> {
  const duration = Date.now() - getVar('checkoutStartTime');
  console.log('âœ“ Checkout complete!');
  console.log('Total time:', duration, 'ms');
  console.log('Session:', getVar('checkoutSessionId'));
  console.log('Transaction:', getVar('transactionId'));
  console.log('Amount:', '$' + getVar('finalTotal'));

	assert(response.status === 200, `Expected status 200, got ${response.status}`);
}

###############################################################################
# 21. SCRIPT CONSOLE & HELPER QUICK REFERENCE
###############################################################################
# Available script helpers (pre or post blocks):
# - setVar(key, value) / getVar(key)
# - setHeader(name, value)
# - updateRequest({ url, method, headers, body, ... })
# - assert(condition, message?)
# - delay(milliseconds)
# - console.log/info/warn/error/debug(...args) -> pipes into the floating Script Console
#
# Use the helperShowcase request above to watch logs stream live and inspect how
# headers + URLs can be rewritten without editing the HTTP block. The console tray
# can be collapsed, cleared, and shows which stage (pre/post) emitted each line.

###############################################################################
# 22. BATCH OPERATIONS WITH ITERATION
###############################################################################

### Batch user creation
@name batchUsers
POST https://httpbun.com/post
Content-Type: application/json

{
  "users": [
    {"email": "user1@example.com", "name": "User One"},
    {"email": "user2@example.com", "name": "User Two"},
    {"email": "user3@example.com", "name": "User Three"}
  ]
}

> {
  const users = JSON.parse(request.body).users;
  const userIds = [];

  users.forEach((user, index) => {
    const userId = 'user-' + (index + 1) + '-' + Math.random().toString(36).substr(2, 6);
    userIds.push(userId);
    console.log(`Created ${user.name} with ID: ${userId}`);
  });

  setVar('createdUserIds', JSON.stringify(userIds));
  setVar('totalUsersCreated', userIds.length);
}

###############################################################################
# 23. DATA VALIDATION & TESTING
###############################################################################

### Comprehensive validation test
@name validationTest
POST https://httpbun.com/post
Content-Type: application/json

{
  "slideshow": {
    "title": "Sample Slide Show",
    "author": "Yours Truly",
    "date": "date of publication",
    "slides": [
      {
        "title": "Wake up to WonderWidgets!",
        "type": "all"
      },
      {
        "title": "Overview",
        "type": "all",
        "items": [
          "Why WonderWidgets are great",
          "Who buys WonderWidgets"
        ]
      }
    ]
  }
}

> {
  assert(response.status === 200, `Expected status 200, got ${response.status}`);
  const ct = response.headers?.['Content-Type'] || response.headers?.['content-type'] || '';
  assert(
    String(ct).toLowerCase().includes('application/json'),
    `Expected Content-Type to include application/json, got ${ct}`
  );
  assert(response.json != null, 'Expected response.json to be non-null');

  // Custom validation logic
  const data = response.json?.slideshow
    ? response.json
    : (response.json?.json || response.json?.data || response.json);
  const errors = [];

  if (!data?.slideshow) {
    errors.push('Missing slideshow object');
  }

  if (!data?.slideshow?.title) {
    errors.push('Missing title');
  }

  if (errors.length > 0) {
    console.error('Validation errors:', errors);
    setVar('validationPassed', false);
  } else {
    console.log('âœ“ All validations passed');
    setVar('validationPassed', true);
  }
}

###############################################################################
# END OF EXAMPLES
###############################################################################
# This file is a "kitchen sink" playground for the app. Itâ€™s meant to be runnable
# out-of-the-box (default env points at https://httpbun.com) and demonstrate common
# patterns RawRequest supports:
#
# âœ“ Environment variables (@env.{env}.{key})
# âœ“ Global variables (@varName)
# âœ“ Common HTTP methods + headers + bodies
# âœ“ Request naming (@name)
# âœ“ Request chains (@depends)
# âœ“ Pre/post scripts (< { ... } / > { ... }) + helper APIs
# âœ“ Assertions via scripts (assert(...))
# âœ“ Load testing (@load), including ramping, wait time, RPS caps, early aborts,
#   and adaptive backoff (ramp â†’ back off â†’ stable â†’ stop)
# âœ“ Secrets usage ({{secret:key}})
#
# SCRIPT API REFERENCE:
# - setVar(key, value)     â†’ Set a variable
# - getVar(key)            â†’ Get a variable value
# - setHeader(name, value) â†’ Inject/override an outgoing header
# - updateRequest(patch)   â†’ Modify URL/method/body/headers during scripts
# - delay(ms)              â†’ Awaitable delay helper for async flows
# - assert(condition,msg)  â†’ Throw when assertions fail
# - console.log/warn/error â†’ Log messages to console
# - response.status        â†’ HTTP status code
# - response.headers       â†’ Response headers object
# - response.json          â†’ Parsed JSON response body
# - response.text          â†’ Raw response body text
# - request.method         â†’ Request HTTP method
# - request.url            â†’ Request URL
# - request.headers        â†’ Request headers object
# - request.body           â†’ Request body
#
###############################################################################
